{# On h√©rite du template de base (base.html.twig) #}
{% extends 'base.html.twig' %}

{# On h√©rite du template de base (base.html.twig) #}
{% block title %}{{ article.titre }} - Bolonews{% endblock %}

{# Bloc principal du contenu affich√© dans le body #}
{% block body %}

    <div class="article-detail">
        {# Lien retour vers la page d‚Äôaccueil #}
        <a href="{{ path('app_home') }}" style="color:#555;">‚Üê Retour aux articles</a>

        {# Titre de l‚Äôarticle #}
        <h1>{{ article.titre }}</h1>

        {# Affiche l‚Äôimage si elle existe #}
        {% if article.image %}
            <img src="{{ asset('uploads/images/' ~ article.image) }}" alt="{{ article.titre }}">
        {% endif %}
        

        {# M√©tadonn√©es de l‚Äôarticle (cat√©gorie, auteur, date) #}
        <p class="article-meta">
            <strong>Cat√©gorie :</strong> {{ article.categorie ?? 'Non cat√©goris√©' }}<br>
            <strong>Auteur :</strong> {{ article.auteur ? article.auteur.pseudo : 'Inconnu' }}<br>
            <strong>Publi√© le :</strong> {{ article.dateCreation|date('d/m/Y √† H:i') }}
        </p>

        <hr>
        {# Affiche le chapeau (court r√©sum√© intro) #}
        <p style="font-style: italic;">{{ article.chapeau }}</p>

        {# Contenu de l‚Äôarticle #}
        <div class="article-content">
            <p>{{ article.contenu|nl2br }}</p>
        </div>

        <hr>
        {% if app.user and (app.user == article.auteur or 'ROLE_ADMIN' in app.user.roles) %}
    <a href="{{ path('article_edit', {id: article.id}) }}" class="btn btn-secondary">‚úèÔ∏è Modifier</a>
        {% endif %}

        {# BOUTON LIKE ‚Äî affich√© uniquement si l‚Äôutilisateur est connect√© #}
        {% if app.user %}
        {# Formulaire POST pour aimer ou unliker l‚Äôarticle actuel #}
            <form method="post" action="{{ path('article_like', { id: article.id }) }}">
            {# Bouton "like" stylis√© : ajoute la classe .liked si l‚Äôutilisateur a d√©j√† lik√© l‚Äôarticle #}
                <button type="submit" class="like-btn{% if article.likedBy.contains(app.user) %} liked{% endif %}">
                    {# Affiche une ic√¥ne C≈íUR PLEIN si l'utilisateur a d√©j√† lik√© (gr√¢ce √† la relation likedBy) #}
                    {% if article.likedBy.contains(app.user) %}
                        <span class="like-icon liked">
                        {# Ic√¥ne UX Symfony : c≈ìur rempli (like d√©j√† actif) #}
                            {{ ux_icon('weui:like-filled', { class: 'coeur-xxl' }) }}
                        </span>
                    {% else %}
                    {# Sinon, ic√¥ne C≈íUR VIDE (non lik√©) #}
                        <span class="like-icon">
                            {{ ux_icon('weui:like-outlined', { class: 'coeur-xxl' }) }}
                        </span>
                    {% endif %}
                    {# Affiche le nombre de "j'aime" pour l‚Äôarticle (max affich√© : 10+) #}
                    <span class="like-count">
                        {% set nbLikes = article.likedBy|length %}
                        {{ nbLikes > 10 ? '10+' : nbLikes }}
                    </span>
                    <span class="comment-icon" >
                    {# Ic√¥ne UX Symfony : bulle de commentaire #}
                        {{ ux_icon('iconamoon:comment', { class: 'comment-bulle' }) }}
                        {# Nombre de commentaires associ√©s √† l‚Äôarticle #}
                        <span class="comment-count">{{ article.commentaires|length }}</span>
                    </span>
                </button>
            </form>

        {% else %}
             {# Si l‚Äôutilisateur n‚Äôest pas connect√©, on invite √† se connecter #}
            <p><a href="{{ path('app_login') }}">Connecte-toi </a> pour aimer cet article.</p>
        {% endif %}

        <hr>

        {# Formulaire pour ajouter un commentaire #}
        {% if app.user %}
            <h3>Ajouter un commentaire</h3>
            {# D√©marre le formulaire Symfony (g√©n√®re la balise <form ...>) #}
            {{ form_start(formCommentaire) }}
                {# Affiche le champ textarea "contenu" avec son label / erreurs / champ #}
                {{ form_row(formCommentaire.contenu) }}
                <button type="submit" class="btn btn-secondary">Publier</button>
            {# Ferme automatiquement la balise </form> #}
            {{ form_end(formCommentaire) }}
        {% else %}
            {# Si l'utilisateur n'est pas connect√©, on affiche un message d‚Äôinvitation √† se connecter #}
            <p><a href="{{ path('app_login') }}">Connecte-toi</a> pour publier un commentaire.</p>
        {% endif %}

        <hr>

        {# Liste des commentaires pr√©sents sur l‚Äôarticle #}
        <h3>Commentaires ({{ article.commentaires|length }})</h3>
        {# On parcourt tous les commentaires li√©s √† l‚Äôarticle #}
        {% for commentaire in article.commentaires %}
            <div class="commentaire">
            {# D√©but du paragraphe contenant l‚Äôauteur et la date du commentaire #}
            <p>
                {# Affiche le pseudo de l‚Äôauteur du commentaire #}
                <strong>{{ commentaire.auteur.pseudo }}</strong>
                {# Affiche la date et l‚Äôheure de publication du commentaire #}
                le {{ commentaire.datePublication|date('d/m/Y H:i') }}
            </p>
            {# Affiche le contenu du commentaire (le texte saisi par l‚Äôutilisateur) #}
            <p>{{ commentaire.contenu }}</p>

        {# Optionnel : bouton supprimer pour l‚Äôauteur du commentaire #}
        {% if app.user and app.user == commentaire.auteur %}
            <form method="post" action="{{ path('commentaire_delete', { id: commentaire.id }) }}" style="margin-top:10px;">
                <input type="hidden" name="_token" value="{{ csrf_token('delete_commentaire_' ~ commentaire.id) }}">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Supprimer ce commentaire ?')">üóë Supprimer</button>
            </form>
        {% endif %}

    </div>
    {# Bloc alternatif : si aucun commentaire, message par d√©faut #}
        {% else %}
            <p>Aucun commentaire pour cet article.</p>
        {% endfor %}


    </div>
{% endblock %}
